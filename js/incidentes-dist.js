const dbref=firebase.database(),user="test@gmail.com",key="123456";let myaudio,contActual=0,cont=0,primercont=[],modalNuevoIncidente=document.getElementById("staticBackdrop"),btnNuevoIncidente=document.getElementById("btnNuevoIncidente"),btnActivarModal=document.querySelector(".btn-activar-modal"),mainBody=document.getElementById("main-body"),btnCloseModal=document.querySelectorAll(".btn-close-modal"),containerModal2=document.querySelector(".container-modal2"),arregloConEmailUsurios=[],iconFlecha='<svg\n    xmlns="http://www.w3.org/2000/svg"\n    width="16"\n    height="16"\n    fill="currentColor"\n    class="bi bi-arrow-left-circle-fill"\n    viewBox="0 0 16 16"\n  >\n    <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z" />\n  </svg>',iconFoto='<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">\n  <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>\n  <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>\n</svg>';function loadIncidents(){console.log(alerts);let e=0;firebase.auth().signInWithEmailAndPassword(user,key).then((a=>{dbref.ref().child("incidentes").on("value",(a=>{document.getElementById("alerts__list").innerHTML="";var t=[];a.forEach((function(e){t.push(e.val())})),t.sort((function(e,a){var t=new Date(formatDate(e.fecha,e.hora));return new Date(formatDate(a.fecha,a.hora)).getTime()-t.getTime()})),t.forEach((a=>{cont2++,e++,console.log("data",a),showList(a,e),cont++,banderaEliminado=null})),console.log(`El contador actual es de: ${cont}`),console.log(`Este es el contador 2: ${cont2}`),e=0,cont2===cont+1&&(modalNuevoIncidente.classList.add("show"),modalNuevoIncidente.style.display="block",myaudio=new Audio("./audio/alert.mp3"),myaudio.volume=1,myaudio.setAttribute("loop","loop"),myaudio.play()),cont2=1,cont=0,addMarquer(),oTable=$("#tablaUsuarios").dataTable(),$.each(oTable.fnGetData(),(function(e,a){arregloConEmailUsurios.push(a[4])}))}))})).catch((e=>{var a=e.code,t=e.message;console.error("error "+a+" "+t)}))}function formatDate(e,a){var t=e.split("/")[0],n=e.split("/")[1];return e.split("/")[2]+"-"+n+"-"+t+" "+a}btnCloseModal.forEach((e=>{e.addEventListener("click",(()=>{modalNuevoIncidente.style.display="",modalNuevoIncidente.classList.remove("show"),myaudio.removeAttribute("loop"),imagenPrincipal.classList.add("d-none"),tablaUsuarios.classList.add("d-none"),sidebar.classList.add("close"),alertsDetails.classList.add("d-none"),mapAlerts.classList.add("d-none"),tablaIncidencias.classList.add("d-none"),alerts.classList.add("left-none"),alerts.classList.remove("d-none"),leyendaAlertas.classList.remove("d-none")}))}));let tConvert=e=>((e=e.toString().match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/)||[e]).length>1&&((e=e.slice(1))[5]=+e[0]<12?" AM":" PM",e[0]=+e[0]%12||12),e.join(""));function showList(e,a){let t=tConvert(e.hora);document.getElementById("alerts__list").innerHTML+=`<li class="alerts__list-items alert-type-${e.titulo}">\n    <a class="alerts__list-link" href="#" id="alert${a}" data-id="${e.uid}">\n    <span class="alerts__list-date">${e.fecha}</span>\n    <span class="alerts__list-hour">${t}</span>\n    </a>\n    </li>`,e=null,a=0}function loadIncidentDetail(e){firebase.auth().signInWithEmailAndPassword(user,key).then((a=>{dbref.ref().child("incidentes").child(e).on("value",(e=>{let a=e.val();getDataUser(a.usuario,a),destinationLocation=new google.maps.LatLng(a.latitud,a.longitud),map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:destinationLocation});const t=new google.maps.InfoWindow({content:a.titulo}),n=new google.maps.Marker({position:destinationLocation,map:map,title:"Uluru (Ayers Rock)"});n.addListener("click",(()=>{t.open({anchor:n,map:map,shouldFocus:!1})}))}))})).catch((e=>{var a=e.code,t=e.message;console.error("error "+a+" "+t)}))}function generateMarker({position:e,title:a}){return new google.maps.Marker({position:e,title:a,map:map,animation:google.maps.Animation.DROP})}function showDetailIncident(e,a){document.getElementById("alerts-details-incident").innerHTML="",document.getElementById("alerts-details-incident").innerHTML=`\n  \n  <button class="btn-ver-lista" id="btn-ver-lista">\n    <span class="icon-flecha">${iconFlecha}</span>\n  </button>\n\n  <ul class="alerts-details__list">\n    <li class="alerts-details__item">\n      <span class="alerts-details__key alerts-details__title-key"\n      >TITULO INCIDENTE:</span\n    >\n    <span class="alerts-details__valor alerts-details__title-valor"\n      >${e.titulo}</span>\n    </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__description-key"\n      >DESCRIPCIÓN:</span\n    >\n    <span\n      class="alerts-details__valor alerts-details__description-valor"\n      >${e.descripcion}</span\n    >\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__date-key"\n      >FECHA:</span\n    >\n    <span class="alerts-details__valor alerts-details__date-valor"\n      >${e.fecha}\n    </span>\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__hour-key"\n      >HORA:</span\n    >\n    <span class="alerts-details__valor alerts-details__hour-valor"\n      >${e.hora}</span\n    >\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__name-key"\n      >NOMBRE:</span\n    >\n    <span class="alerts-details__valor alerts-details__name-valor"\n      >${a.nombres}</span\n    >\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__lastname-key"\n      >APELLIDO:</span\n    >\n    <span class="alerts-details__valor alerts-details__lastname-valor"\n      >${a.apellidos}</span\n    >\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__dni-key"\n      >DNI:</span\n    >\n    <span class="alerts-details__valor alerts-details__dni-valor"\n      >${a.numerodocumento}</span\n    >\n  </li>\n\n  <li class="alerts-details__item">\n    <span class="alerts-details__key alerts-details__phone-key"\n      >TELEFONO:</span\n    >\n    <span class="alerts-details__valor alerts-details__phone-valor"\n      >${a.telefono}</span\n    >\n  </li>\n\n  <li class="alerts-details__item alerts-details__item-photo">\n    <span class="alerts-details__key alerts-details__photo-key"\n      >FOTO:</span\n    >\n    <a\n            href="./image/imagen-no-disponible.jpg"\n            class="alerts-details__valor alerts-details__photo-valor"\n            data-lightbox="myGallery"\n            data-title="Foto enviada por poblador."\n            id="myGallery">Ver Foto</a\n          >\n    </a>\n    <div class="iconFoto">${iconFoto}</div>\n  </li>\n</ul>`,"Asalto o Robo"!==e.titulo&&"Accidente de Tránsito"!==e.titulo&&"Nuevo Caso de Violencia"!==e.titulo&&getImage(e.imagen)}function getDataUser(e,a){let t;firebase.database().ref("usuarios").child(e).on("value",(e=>{t=e.val(),showDetailIncident(a,t),document.getElementById("alerts-details-incident").appendChild='\n      <button class="btn-ver-lista" id="btn-ver-lista">\n        <i class="far fa-arrow-alt-circle-left icon-flecha"></i>\n      </button>\n    ';let n=document.getElementById("btn-ver-lista");null!=n&&n.addEventListener("click",(()=>{alerts.classList.add("left-none"),sidebar.classList.add("close"),alertsDetails.classList.add("d-none"),alertsDetails.style.opacity=1,mapAlerts.classList.add("d-none"),tablaUsuarios.classList.add("d-none"),tablaIncidencias.classList.add("d-none"),imagenPrincipal.classList.add("d-none"),leyendaAlertas.classList.remove("d-none"),alerts.classList.remove("d-none")}))}))}function getImage(e){firebase.storage().ref(e).getDownloadURL().then((function(e){var a=new XMLHttpRequest;a.responseType="blob",a.onload=function(e){a.response},a.open("GET",e),a.send(),document.getElementById("myGallery").setAttribute("href",e)})).catch((function(e){console.error("Error",e)}))}